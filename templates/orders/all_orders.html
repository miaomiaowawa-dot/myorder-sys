{% extends "base.html" %}

{% block title %}全部订单 - 订单管理系统{% endblock %}

{% block content %}
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-header">
            <div class="layui-row">
                <div class="layui-col-md6">
                    <h2 style="margin: 0;">
                        <i class="layui-icon layui-icon-list"></i> 全部订单
                    </h2>
                </div>
                <div class="layui-col-md6" style="text-align: right;">
                    <button class="layui-btn layui-btn-normal layui-btn-sm" onclick="refreshData()">
                        <i class="layui-icon layui-icon-refresh"></i> 刷新
                    </button>
                    <button class="layui-btn layui-btn-warm layui-btn-sm" onclick="exportData()">
                        <i class="layui-icon layui-icon-export"></i> 导出
                    </button>
                </div>
            </div>
        </div>
        <div class="layui-card-header">
            <i class="layui-icon layui-icon-list"></i> 所有订单
            <a href="{{ url_for('orders.add_order_page') }}" class="layui-btn layui-btn-normal layui-btn-sm" style="float: right;">
                <i class="layui-icon">&#xe654;</i> 添加订单
            </a>
        </div>
        
        <div class="layui-card-body">
            <!-- 搜索和筛选区域 -->
            <div class="layui-form">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-md3">
                        <div class="layui-input-inline">
                            <input type="text" id="search-input" placeholder="搜索订单ID、信息、备注..." 
                                   class="layui-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="layui-col-md2">
                        <select id="status-filter" class="layui-select">
                            <option value="">全部状态</option>
                            <option value="pending">待使用</option>
                            <option value="started">已开始</option>
                            <option value="used">已完成</option>
                            <option value="cancel">已取消</option>
                        </select>
                    </div>
                    <div class="layui-col-md2">
                        <button class="layui-btn layui-btn-primary" onclick="searchOrders()">
                            <i class="layui-icon layui-icon-search"></i> 搜索
                        </button>
                        <button class="layui-btn layui-btn-primary" onclick="resetSearch()">
                            <i class="layui-icon layui-icon-refresh"></i> 重置
                        </button>
                    </div>
                </div>
            </div>

            <!-- 订单表格 -->
            <table class="layui-table" id="orders-table" lay-filter="orders-table">
                <thead>
                    <tr>
                        <th width="80">订单ID</th>
                        <th>订单信息</th>
                        <th width="100">原价</th>
                        <th width="100">折扣价</th>
                        <th width="150">购买时间</th>
                        <th width="100">状态</th>
                        <th>备注</th>
                        <th width="150" class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody id="orders-body">
                    <!-- 数据通过JavaScript动态加载 -->
                </tbody>
            </table>

            <!-- 分页 -->
            <div id="pagination" style="text-align: center; margin-top: 20px;"></div>
        </div>
    </div>
</div>

<!-- 操作列模板 -->

{% endblock %}

{% block styles %}
<style>
.text-center {
    text-align: center;
}
.layui-table td, .layui-table th {
    text-align: center;
}
.layui-table td:first-child, .layui-table th:first-child {
    text-align: center;
}
.layui-table td:nth-child(2) {
    text-align: left;
}
.layui-table td:last-child {
    text-align: center;
}
.loading {
    text-align: center;
    padding: 20px;
    color: #999;
}
.status-badge {
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 12px;
    color: white;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// 全局变量
let currentPage = 1;
const limit = 15;
let currentSearch = '';
let currentStatus = '';

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
    initLayuiComponents();
});

// 初始化LayUI组件
function initLayuiComponents() {
    layui.use(['form', 'layer'], function(){
        window.form = layui.form;
        window.layer = layui.layer;
        form.render();
    });
}

// 加载订单数据
function loadOrders(page = 1, search = '', status = '') {
    currentPage = page;
    currentSearch = search || document.getElementById('search-input').value;
    currentStatus = status || document.getElementById('status-filter').value;
    
    const tbody = document.getElementById('orders-body');
    tbody.innerHTML = '<tr><td colspan="8" class="loading"><i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate"></i> 加载中...</td></tr>';
    
    // 修正URL路径 - 添加 /orders 前缀
    let url = `/orders/api/orders?page=${page}&limit=${limit}`;
    if (currentSearch) {
        url += `&search=${encodeURIComponent(currentSearch)}`;
    }
    if (currentStatus) {
        url += `&status=${encodeURIComponent(currentStatus)}`;
    }
    
    console.log('请求URL:', url);
    
    fetch(url, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('响应状态:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP错误! 状态: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('响应数据:', data);
        if (data.code === 0) {
            renderOrders(data.data);
            renderPagination(data.count, page);
        } else {
            layer.msg('加载数据失败: ' + data.msg, {icon: 2});
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">加载失败: ' + data.msg + '</td></tr>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        layer.msg('网络错误，请稍后重试', {icon: 2});
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">网络错误</td></tr>';
    });
}

// 渲染订单数据
function renderOrders(orders) {
    const tbody = document.getElementById('orders-body');
    
    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999; padding: 40px;">暂无订单数据</td></tr>';
        return;
    }
    
    let html = '';
    orders.forEach(order => {
        html += `
            <tr>
                <td><strong>${order.order_id || '-'}</strong></td>
                <td style="text-align: left;">${order.order_info || '-'}</td>
                <td>${order.order_price ? '¥' + order.order_price : '-'}</td>
                <td>${order.order_disprice ? '¥' + order.order_disprice : '-'}</td>
                <td>${order.order_buytime || '-'}</td>
                <td>
                    <span class="layui-badge layui-bg-${order.status_color}">
                        ${order.status_text}
                    </span>
                </td>
                <td style="text-align: left;">${order.order_remark || '-'}</td>
                <td>
                    <div class="layui-btn-group">
                        <button class="layui-btn layui-btn-xs" onclick="viewOrder('${order.order_id}')">
                            <i class="layui-icon layui-icon-search"></i> 查看
                        </button>
                        <button class="layui-btn layui-btn-xs layui-btn-normal" onclick="editOrder('${order.order_id}')">
                            <i class="layui-icon layui-icon-edit"></i> 编辑
                        </button>
                        <button class="layui-btn layui-btn-xs layui-btn-danger" onclick="deleteOrder('${order.order_id}')">
                            <i class="layui-icon layui-icon-delete"></i> 删除
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function renderPagination(total, currentPage) {
    const totalPages = Math.ceil(total / limit);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '<div class="layui-box layui-laypage layui-laypage-default">';
    
    // 首页
    html += currentPage > 1 
        ? `<a href="javascript:;" class="layui-laypage-first" onclick="loadOrders(1)">首页</a>`
        : `<span class="layui-laypage-first layui-disabled">首页</span>`;
    
    // 上一页
    html += currentPage > 1 
        ? `<a href="javascript:;" class="layui-laypage-prev" onclick="loadOrders(${currentPage - 1})">«</a>`
        : `<span class="layui-laypage-prev layui-disabled">«</span>`;
    
    // 页码（简化显示）
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            html += `<span class="layui-laypage-curr"><em class="layui-laypage-em"></em><em>${i}</em></span>`;
        } else {
            html += `<a href="javascript:;" onclick="loadOrders(${i})">${i}</a>`;
        }
    }
    
    // 下一页
    html += currentPage < totalPages 
        ? `<a href="javascript:;" class="layui-laypage-next" onclick="loadOrders(${currentPage + 1})">»</a>`
        : `<span class="layui-laypage-next layui-disabled">»</span>`;
    
    // 末页
    html += currentPage < totalPages 
        ? `<a href="javascript:;" class="layui-laypage-last" onclick="loadOrders(${totalPages})">末页</a>`
        : `<span class="layui-laypage-last layui-disabled">末页</span>`;
    
    // 简单统计信息
    html += `<span class="layui-laypage-count">共 ${total} 条</span>`;
    
    html += '</div>';
    pagination.innerHTML = html;
}

// 搜索订单
function searchOrders() {
    loadOrders(1);
}

// 重置搜索
function resetSearch() {
    document.getElementById('search-input').value = '';
    document.getElementById('status-filter').value = '';
    loadOrders(1);
}

// 刷新数据
function refreshData() {
    loadOrders(currentPage);
}

// 导出数据
function exportData() {
    layer.msg('导出功能开发中...', {icon: 0});
}

// 查看订单详情
function viewOrder(orderId) {
    layer.msg('查看订单: ' + orderId, {icon: 1});
    // 这里可以跳转到订单详情页面或打开详情弹窗
}

// 编辑订单
function editOrder(orderId) {
    layer.msg('编辑订单: ' + orderId, {icon: 1});
    // 这里可以跳转到编辑页面或打开编辑弹窗
}

// 删除订单
function deleteOrder(orderId) {
    layer.confirm('确定要删除这个订单吗？', {
        icon: 3,
        title: '删除确认'
    }, function(index){
        layer.msg('删除订单: ' + orderId, {icon: 1});
        // 这里可以调用删除API
        layer.close(index);
    });
}

// 监听搜索框回车键
document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchOrders();
    }
});
</script>
{% endblock %}